{% extends 'layout.html' %}
{% block content %}
  <h2>‚öôÔ∏è Panneau d'administration</h2>

  <div class="admin-container">
    <section class="admin-section">
      <h3>Actions administrateur</h3>
      <div class="stats-grid">
        <div>
          <h4>Inscrire un usager</h4>
          <form method="post" action="{{ url_for('register') }}">
            <label for="admin-register-name">Nom</label>
            <input id="admin-register-name" name="name" type="text" required>
            <label for="admin-register-email">Email</label>
            <input id="admin-register-email" name="email" type="email" required>
            <button type="submit" class="btn-small">Inscrire</button>
          </form>
        </div>

        <div>
          <h4>Creer un emprunt pour un usager inscrit</h4>
          <form method="post" action="{{ url_for('borrow') }}">
            <label for="admin-borrow-user">Usager inscrit</label>
            <select id="admin-borrow-user" name="user_id" required>
              <option value="">-- Choisir un usager --</option>
              {% for user in approved_users %}
                <option value="{{ user.id }}">{{ user.name }} ({{ user.email }})</option>
              {% endfor %}
            </select>

            <label for="admin-borrow-book">Ouvrage</label>
            <select id="admin-borrow-book" name="book_id" required>
              <option value="">-- Choisir un ouvrage --</option>
              {% for book in books %}
                <option value="{{ book.id }}">{{ book.title }} - {{ book.author }}</option>
              {% endfor %}
            </select>
            <button type="submit" class="btn-small">Faire emprunt</button>
          </form>
        </div>

        <div>
          <h4>Creer une reservation pour un usager inscrit</h4>
          <form method="post" action="{{ url_for('reserve') }}">
            <label for="admin-reserve-user">Usager inscrit</label>
            <select id="admin-reserve-user" name="user_id" required>
              <option value="">-- Choisir un usager --</option>
              {% for user in approved_users %}
                <option value="{{ user.id }}">{{ user.name }} ({{ user.email }})</option>
              {% endfor %}
            </select>

            <label for="admin-reserve-book">Ouvrage</label>
            <select id="admin-reserve-book" name="book_id" required>
              <option value="">-- Choisir un ouvrage --</option>
              {% for book in books %}
                <option value="{{ book.id }}">{{ book.title }} - {{ book.author }}</option>
              {% endfor %}
            </select>
            <button type="submit" class="btn-small">Faire reservation</button>
          </form>
        </div>
      </div>
    </section>

    <section class="admin-section">
      <h3>Inscriptions usagers en attente</h3>
      {% if pending_users %}
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Nom</th>
              <th>Email</th>
              <th>Demande le</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            {% for user in pending_users %}
            <tr>
              <td>{{ user.id }}</td>
              <td>{{ user.name }}</td>
              <td>{{ user.email }}</td>
              <td>{{ user.registered_on.strftime('%d/%m/%Y') }}</td>
              <td>
                <form method="post" action="{{ url_for('approve_user', user_id=user.id) }}" style="display:inline">
                  <button type="submit" class="btn-small">Valider</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p class="empty-message">Aucune inscription en attente.</p>
      {% endif %}
    </section>

    <!-- Section Emprunts Actifs -->
    <section class="admin-section">
      <h3>üì§ Emprunts actifs</h3>
      {% if active_loans %}
        <table>
          <thead>\n            <tr>\n              <th>ID</th>\n              <th>Usager</th>\n              <th>Livre</th>\n              <th>Emprunt√© le</th>\n              <th>Date limite</th>\n              <th>Statut</th>\n              <th>Actions</th>\n            </tr>
          </thead>
          <tbody>
            {% for loan in active_loans %}
            <tr>
              <td>{{ loan.id }}</td>
              <td>{{ loan.user.name }}</td>
              <td>{{ loan.book.title }}</td>
              <td>{{ loan.borrowed_on.strftime('%d/%m/%Y') }}</td>
              <td>
                <span class="date {% if loan.due_date < now %}overdue{% endif %}">
                  {{ loan.due_date.strftime('%d/%m/%Y') }}
                </span>
              </td>
              <td>
                {% if loan.due_date < now %}
                  <span class="badge danger">En retard</span>
                {% else %}
                  <span class="badge success">En cours</span>
                {% endif %}
              </td>
              <td>
                <form method="post" action="{{ url_for('return_book') }}" style="display:inline">
                  <input type="hidden" name="loan_id" value="{{ loan.id }}">
                  <button type="submit" class="btn-small">‚úì Retour</button>
                </form>
                <form method="post" action="{{ url_for('extend_loan', loan_id=loan.id) }}" style="display:inline">
                  <button type="submit" class="btn-small">+7j</button>
                </form>
                <form method="post" action="{{ url_for('cancel_loan', loan_id=loan.id) }}" style="display:inline">
                  <button type="submit" class="btn-small danger-btn" onclick="return confirm('Interrompre cet emprunt ?')">Interrompre</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p class="empty-message">Aucun emprunt actif</p>
      {% endif %}
    </section>

    <!-- Section R√©servations -->
    <section class="admin-section">
      <h3>üîñ R√©servations en attente</h3>
      {% if reservations %}
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Usager</th>
              <th>Livre</th>
              <th>R√©serv√© le</th>
              <th>Expire le</th>
              <th>Disponibilit√©</th>
              <th>Statut</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for res in reservations %}
            <tr>
              <td>{{ res.id }}</td>
              <td>{{ res.user.name }}</td>
              <td>{{ res.book.title }}</td>
              <td>{{ res.reserved_on.strftime('%d/%m/%Y') }}</td>
              <td>
                {% if res.expires_on %}
                  {{ res.expires_on.strftime('%d/%m/%Y') }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td>
                {% if res.book.available_copies() > 0 %}
                  <span class="badge success">Disponible</span>
                {% else %}
                  <span class="badge danger">Indisponible</span>
                {% endif %}
              </td>
              <td>
                {% if res.active %}
                  {% if res.expires_on and res.expires_on < now %}
                    <span class="badge danger">Expiree</span>
                  {% else %}
                    <span class="badge warning">En attente</span>
                  {% endif %}
                {% else %}
                  <span class="badge success">Compl√©t√©e</span>
                {% endif %}
              </td>
              <td>
                {% if res.active %}
                  <form method="post" action="{{ url_for('extend_reservation', reservation_id=res.id) }}" style="display:inline">
                    <button type="submit" class="btn-small">+7j</button>
                  </form>
                  <form method="post" action="{{ url_for('cancel_reservation', reservation_id=res.id) }}" style="display:inline">
                    <button type="submit" class="btn-small danger-btn" onclick="return confirm('Interrompre cette reservation ?')">Interrompre</button>
                  </form>
                  {% if res.book.available_copies() > 0 %}
                    <form method="post" action="{{ url_for('fulfill_reservation', reservation_id=res.id) }}" style="display:inline">
                      <button type="submit" class="btn-small">Convertir en emprunt</button>
                    </form>
                  {% else %}
                    <span class="badge warning">En attente de retour</span>
                  {% endif %}
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p class="empty-message">Aucune r√©servation</p>
      {% endif %}
    </section>

    <!-- Section Historique des retours -->
    <section class="admin-section">
      <h3>üì• Retours r√©cents</h3>
      {% if returned_loans %}
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Usager</th>
              <th>Livre</th>
              <th>Emprunt√©</th>
              <th>Date limite</th>
              <th>Statut</th>
            </tr>
          </thead>
          <tbody>
            {% for loan in returned_loans %}
            <tr>
              <td>{{ loan.id }}</td>
              <td>{{ loan.user.name }}</td>
              <td>{{ loan.book.title }}</td>
              <td>{{ loan.borrowed_on.strftime('%d/%m/%Y') }}</td>
              <td>{{ loan.due_date.strftime('%d/%m/%Y') }}</td>
              <td>
                <span class="success">‚úì Retourn√©</span>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p class="empty-message">Aucun retour r√©cent</p>
      {% endif %}
    </section>

    <!-- Section Statistiques des R√©servations -->
    <section class="admin-section reservations-stats">
      <h3>üìä Statistiques des r√©servations</h3>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number">{{ reservations|length }}</div>
          <div class="stat-label">R√©servations totales</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ reservations|selectattr('active')|list|length }}</div>
          <div class="stat-label">En attente</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ reservations|rejectattr('active')|list|length }}</div>
          <div class="stat-label">Compl√©t√©es</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ reservations|map(attribute='user_id')|unique|list|length }}</div>
          <div class="stat-label">Usagers uniques</div>
        </div>
      </div>
    </section>

    <!-- Section Statistiques Globales -->
    <section class="admin-section stats-section">
      <h3>üìä Statistiques</h3>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number">{{ total_books }}</div>
          <div class="stat-label">Livres total</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ total_users }}</div>
          <div class="stat-label">Usagers</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ active_loans_count }}</div>
          <div class="stat-label">Emprunts actifs</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ reservations_count }}</div>
          <div class="stat-label">R√©servations</div>
        </div>
      </div>
    </section>
  </div>

{% endblock %}
